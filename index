<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>CRM é ˜èˆªå“¡ é›¢ç·šå°ˆæ¥­ç‰ˆ</title>
    <script src="https://unpkg.com/vue@3/dist/vue.global.js"></script>
    <script src="https://cdn.tailwindcss.com"></script>
    <script type="text/javascript" src="https://unpkg.com/vis-network/standalone/umd/vis-network.min.js"></script>
    <style>
        body { background-color: #f1f5f9; font-family: "PingFang TC", sans-serif; -webkit-tap-highlight-color: transparent; }
        .tab-content { height: calc(100vh - 80px); overflow-y: auto; padding-bottom: 100px; }
        #main-network { width: 100%; height: 70vh; background: #000; border-radius: 12px; }
        .sub-network { width: 100%; height: 250px; background: #111827; border-radius: 12px; margin-top: 10px; }
        .active-tab { color: #3b82f6; border-top: 3px solid #3b82f6; background-color: #f8fafc; }
        /* NPSS æ¨™ç±¤æ¨£å¼ */
        .npss-tag { font-size: 10px; padding: 2px 6px; border-radius: 4px; font-weight: bold; }
        .bg-pa { background: #dbeafe; color: #1e40af; }
        .bg-af { background: #ffedd5; color: #9a3412; }
        .bg-pc { background: #fee2e2; color: #b91c1c; }
        .bg-c  { background: #faf5ff; color: #6b21a8; }
        .bg-s  { background: #dcfce7; color: #166534; }
    </style>
</head>
<body>

<div id="app">
    <header class="bg-slate-900 text-white p-4 sticky top-0 z-50 flex justify-between items-center shadow-lg">
        <h1 class="text-lg font-bold">ğŸ§­ {{ currentTabName }}</h1>
        <button @click="exportData" class="text-[10px] bg-white/10 px-2 py-1 rounded border border-white/20">å‚™ä»½è³‡æ–™</button>
    </header>

    <main class="tab-content p-4">
        
        <section v-show="activeTab === 'input'" class="space-y-4">
            <div class="bg-white p-5 rounded-2xl shadow-sm border border-slate-200">
                <div class="grid grid-cols-2 gap-3 mb-4">
                    <div>
                        <label class="text-[10px] font-bold text-slate-400">é—œä¿‚ç­‰ç´š</label>
                        <select v-model="form.level" class="w-full p-3 bg-slate-50 rounded-xl border">
                            <option value="A">A ç´š (æ ¸å¿ƒ)</option>
                            <option value="B">B ç´š (ä¸€èˆ¬)</option>
                            <option value="C">C ç´š (æ·ºå±¤)</option>
                        </select>
                    </div>
                    <div>
                        <label class="text-[10px] font-bold text-slate-400">å®¢æˆ¶å§“å</label>
                        <input v-model="form.name" type="text" placeholder="è¼¸å…¥å§“å" class="w-full p-3 bg-slate-50 rounded-xl border">
                    </div>
                </div>

                <div class="grid grid-cols-2 gap-3 mb-4">
                    <div>
                        <label class="text-[10px] font-bold text-slate-400">ğŸ‚ ç”Ÿæ—¥</label>
                        <input v-model="form.birthday" type="date" class="w-full p-3 bg-slate-50 rounded-xl border text-sm">
                    </div>
                    <div>
                        <label class="text-[10px] font-bold text-slate-400">ğŸ’° å¹´æ”¶(è¬)</label>
                        <input v-model.number="form.income" type="number" class="w-full p-3 bg-slate-50 rounded-xl border">
                    </div>
                </div>

                <div class="mb-4">
                    <label class="text-[10px] font-bold text-slate-400">ğŸ’¼ è·æ¥­å·¥ä½œ (è‡ªå®šç¾©æ¨™ç±¤)</label>
                    <input v-model="form.job" type="text" placeholder="å¦‚ï¼šå·¥ç¨‹å¸«ã€ç™»å±±å‹..." class="w-full p-3 bg-slate-50 rounded-xl border">
                </div>

                <div class="mb-4">
                    <label class="text-[10px] font-bold text-blue-500">ğŸ“ˆ NPSS éŠ·å”®é€²åº¦</label>
                    <select v-model="form.npss" class="w-full p-3 bg-slate-50 rounded-xl border">
                        <option value="PA">PA é–‹ç™¼ç¶“ç‡Ÿ</option>
                        <option value="AF">AF æ¿€ç™¼èˆˆè¶£</option>
                        <option value="PC">PC å»ºè­°ä¿ƒæˆ</option>
                        <option value="C">C æˆäº¤ç°½ç´„</option>
                        <option value="S">S å”®å¾Œæœå‹™</option>
                    </select>
                </div>

                <div class="mb-4">
                    <label class="text-[10px] font-bold text-slate-400">ğŸ¤ å¼•è–¦äºº</label>
                    <select v-model="form.linkName" class="w-full p-3 bg-slate-50 rounded-xl border">
                        <option value="">(ç„¡)</option>
                        <option v-for="c in customers" :value="c.name" :disabled="c.name === form.name">{{ c.name }}</option>
                    </select>
                    <input v-model="form.relationLabel" placeholder="è¼¸å…¥èˆ‡å¼•è–¦äººçš„é—œä¿‚ (å¦‚ï¼šçˆ¶å­ã€åŒäº‹)" class="w-full p-3 bg-slate-50 rounded-xl border mt-2">
                </div>

                <button @click="saveToLocal" class="w-full bg-blue-600 text-white font-bold py-4 rounded-2xl mt-4 shadow-lg active:scale-95 transition">
                    {{ isEditing ? 'æ›´æ–°å®¢æˆ¶è³‡æ–™' : 'ç¢ºèªå„²å­˜åå–®' }}
                </button>
            </div>
        </section>

        <section v-show="activeTab === 'list'" class="space-y-3">
            <input v-model="searchQuery" type="text" placeholder="ğŸ” æœå°‹å§“åã€è·æ¥­æˆ–é—œä¿‚æ¨™ç±¤..." class="w-full p-4 rounded-2xl border shadow-sm sticky top-0 z-10 bg-white/80 backdrop-blur">
            
            <div v-for="c in filteredCustomers" :key="c.id" class="bg-white rounded-2xl border p-4 shadow-sm">
                <div class="flex justify-between items-start" @click="toggleExpand(c)">
                    <div>
                        <div class="flex items-center gap-2">
                            <span class="font-black text-blue-600">{{ c.level }}</span>
                            <span class="font-bold text-lg text-slate-800">{{ c.name }}</span>
                            <span v-if="c.income >= 100" class="text-yellow-500">ğŸ’°</span>
                        </div>
                        <div class="flex gap-1 mt-1">
                            <span class="npss-tag" :class="'bg-' + c.npss.toLowerCase()">{{ getNPSSLabel(c.npss) }}</span>
                            <span class="text-[10px] bg-slate-100 text-slate-500 px-2 py-0.5 rounded">{{ c.job || 'æœªå¡«è·æ¥­' }}</span>
                        </div>
                    </div>
                    <span class="text-slate-300 text-sm">{{ expandedId === c.id ? 'â–²' : 'â–¼' }}</span>
                </div>
                
                <div v-if="expandedId === c.id" class="mt-4 pt-4 border-t">
                    <div class="flex gap-2 mb-4">
                        <button @click.stop="startEdit(c)" class="flex-1 py-2 bg-blue-50 text-blue-600 rounded-lg text-xs font-bold">ç·¨è¼¯è³‡æ–™</button>
                        <button @click.stop="deleteCustomer(c.id)" class="flex-1 py-2 bg-red-50 text-red-600 rounded-lg text-xs font-bold">åˆªé™¤åå–®</button>
                    </div>
                    <div class="text-[11px] text-slate-400 mb-2">ğŸ“ äººè„ˆåœˆï¼š{{ c.relationLabel || 'è‡ªæˆ‘èªè­˜' }}</div>
                    <div :id="'sub-net-' + c.id" class="sub-network"></div>
                </div>
            </div>
        </section>

        <section v-show="activeTab === 'map'">
            <div id="main-network"></div>
            <div class="mt-4 p-4 bg-white rounded-xl text-[10px] text-slate-500 grid grid-cols-2 gap-2 shadow-sm">
                <div>ğŸ”µ è—åœˆï¼šä¸€èˆ¬å®¢æˆ¶</div>
                <div>ğŸŸ¡ é‡‘é‚Šï¼šå¹´æ”¶100è¬+</div>
                <div>ğŸ”´ ç´…è‰²ä¸­å¿ƒï¼šç•¶å‰é¸ä¸­</div>
                <div>ğŸ“ é€£ç·šï¼šä»£è¡¨å¼•è–¦é—œä¿‚</div>
            </div>
        </section>

    </main>

    <nav class="fixed bottom-0 w-full bg-white/90 backdrop-blur-md border-t flex justify-around p-2 pb-6 z-50">
        <button @click="activeTab = 'input'" class="flex flex-col items-center flex-1 py-1 transition" :class="{'active-tab': activeTab === 'input'}">
            <span class="text-xl">âœï¸</span><span class="text-[10px] mt-1 font-bold">è¼¸å…¥è³‡æ–™</span>
        </button>
        <button @click="activeTab = 'list'" class="flex flex-col items-center flex-1 py-1 transition" :class="{'active-tab': activeTab === 'list'}">
            <span class="text-xl">ğŸ“‹</span><span class="text-[10px] mt-1 font-bold">å®¢æˆ¶åå–®</span>
        </button>
        <button @click="activeTab = 'map'" class="flex flex-col items-center flex-1 py-1 transition" :class="{'active-tab': activeTab === 'map'}">
            <span class="text-xl">ğŸ•¸ï¸</span><span class="text-[10px] mt-1 font-bold">äººè„ˆåœ°åœ–</span>
        </button>
    </nav>
</div>

<script>
const { createApp, ref, computed, watch, nextTick, onMounted } = Vue;

createApp({
    setup() {
        const activeTab = ref('list');
        const customers = ref([]);
        const searchQuery = ref('');
        const expandedId = ref(null);
        const isEditing = ref(false);
        const editingId = ref(null);
        
        const form = ref({
            name: '', level: 'B', birthday: '', income: 0, 
            npss: 'PA', job: '', linkName: '', relationLabel: ''
        });

        const currentTabName = computed(() => {
            const map = { input: 'è¼¸å…¥å®¢æˆ¶è³‡æ–™', list: 'å®¢æˆ¶åå–®', map: 'äººè„ˆç¸½è¦½ (é›¢ç·šç‰ˆ)' };
            return map[activeTab.value];
        });

        // è®€å– localStorage
        const loadData = () => {
            const saved = localStorage.getItem('crm_offline_data');
            if (saved) customers.value = JSON.parse(saved);
        };

        const saveToLocal = () => {
            if(!form.value.name) return alert('è«‹å¡«å¯«å§“å');
            
            if(isEditing.value) {
                const idx = customers.value.findIndex(c => c.id === editingId.value);
                customers.value[idx] = { ...form.value, id: editingId.value };
            } else {
                customers.value.push({ ...form.value, id: Date.now() });
            }
            
            localStorage.setItem('crm_offline_data', JSON.stringify(customers.value));
            alert('å„²å­˜æˆåŠŸ');
            resetForm();
            activeTab.value = 'list';
        };

        const resetForm = () => {
            form.value = { name: '', level: 'B', birthday: '', income: 0, npss: 'PA', job: '', linkName: '', relationLabel: '' };
            isEditing.value = false;
            editingId.value = null;
        };

        const startEdit = (c) => {
            form.value = { ...c };
            isEditing.value = true;
            editingId.value = c.id;
            activeTab.value = 'input';
        };

        const deleteCustomer = (id) => {
            if(confirm('ç¢ºå®šè¦åˆªé™¤é€™ä½å®¢æˆ¶å—ï¼Ÿæ­¤æ“ä½œç„¡æ³•é‚„åŸã€‚')) {
                customers.value = customers.value.filter(c => c.id !== id);
                localStorage.setItem('crm_offline_data', JSON.stringify(customers.value));
            }
        };

        const filteredCustomers = computed(() => {
            const q = searchQuery.value.toLowerCase();
            return customers.value.filter(c => 
                c.name.includes(q) || (c.job && c.job.includes(q)) || (c.relationLabel && c.relationLabel.includes(q))
            ).sort((a,b) => a.level.localeCompare(b.level));
        });

        const toggleExpand = (c) => {
            expandedId.value = expandedId.value === c.id ? null : c.id;
            if(expandedId.value) {
                nextTick(() => renderSubMap(c));
            }
        };

        const getNPSSLabel = (val) => {
            const map = { PA: 'é–‹ç™¼', AF: 'æ¿€ç™¼', PC: 'ä¿ƒæˆ', C: 'æˆäº¤', S: 'å”®å¾Œ' };
            return map[val] || val;
        };

        // --- åœ°åœ–æ¸²æŸ“é‚è¼¯ (Main) ---
        const renderMainMap = () => {
            const nodes = customers.value.map(c => ({
                id: c.name,
                label: `${c.level} | ${c.name}`,
                shape: 'box',
                color: { background: '#fff', border: c.income >= 100 ? '#eab308' : '#3b82f6' },
                borderWidth: c.income >= 100 ? 4 : 2,
                font: { size: 14, color: '#000' }
            }));
            const edges = customers.value.filter(c => c.linkName).map(c => ({
                from: c.linkName, to: c.name, label: c.relationLabel, 
                color: '#475569', font: { size: 10, color: '#94a3b8' }
            }));
            new vis.Network(document.getElementById('main-network'), { nodes, edges }, {
                physics: { solver: 'forceAtlas2Based', forceAtlas2Based: { gravitationalConstant: -50 } }
            });
        };

        // --- å€‹åˆ¥åå–®çš„å­æ¨¹ç‹€åœ– (Sub) ---
        const renderSubMap = (root) => {
            // æ‰¾å‡ºï¼š1.å¼•è–¦æˆ‘çš„ 2.æˆ‘å¼•è–¦çš„ 3.è·æ¥­æ¨™ç±¤ç›¸åŒçš„
            const related = customers.value.filter(c => 
                c.name === root.name || 
                c.linkName === root.name || 
                root.linkName === c.name || 
                (c.job === root.job && root.job !== "")
            );
            
            const nodes = related.map(c => ({
                id: c.name, label: c.name, 
                shape: c.name === root.name ? 'diamond' : 'dot',
                size: c.name === root.name ? 20 : 10,
                color: c.name === root.name ? '#ef4444' : '#60a5fa'
            }));
            const edges = related.filter(c => c.linkName).map(c => ({ from: c.linkName, to: c.name, color: '#444' }));
            new vis.Network(document.getElementById('sub-net-' + root.id), { nodes, edges }, { physics: { enabled: true }});
        };

        const exportData = () => {
            const dataStr = JSON.stringify(customers.value);
            const blob = new Blob([dataStr], {type: "application/json"});
            const url = URL.createObjectURL(blob);
            const link = document.createElement('a');
            link.href = url;
            link.download = `CRM_Backup_${new Date().toLocaleDateString()}.json`;
            link.click();
        };

        watch(activeTab, (tab) => {
            if(tab === 'map') nextTick(() => renderMainMap());
        });

        onMounted(loadData);

        return { activeTab, currentTabName, customers, filteredCustomers, form, searchQuery, expandedId, isEditing, saveToLocal, startEdit, deleteCustomer, toggleExpand, getNPSSLabel, exportData };
    }
}).mount('#app');
</script>
</body>
</html>i
