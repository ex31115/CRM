
<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>CRM é ˜èˆªå“¡ é›¢ç·šæ¨™ç±¤ç‰ˆ</title>
    <script src="https://unpkg.com/vue@3/dist/vue.global.js"></script>
    <script src="https://cdn.tailwindcss.com"></script>
    <script type="text/javascript" src="https://unpkg.com/vis-network/standalone/umd/vis-network.min.js"></script>
    <style>
        body { background-color: #f1f5f9; font-family: "PingFang TC", sans-serif; }
        .tab-content { height: calc(100vh - 80px); overflow-y: auto; padding-bottom: 120px; }
        #main-network { width: 100%; height: 70vh; background: #000; border-radius: 12px; }
        .sub-network { width: 100%; height: 300px; background: #000; border-radius: 12px; margin-top: 10px; }
        .active-tab { color: #3b82f6; border-top: 3px solid #3b82f6; background-color: #f8fafc; }
        .tag-chip { font-size: 10px; padding: 2px 8px; border-radius: 99px; font-weight: bold; background: #e2e8f0; color: #475569; }
        /* é¿å…åº•éƒ¨é®æ“‹ */
        .safe-bottom { padding-bottom: 80px; }
    </style>
</head>
<body>

<div id="app">
    <header class="bg-slate-900 text-white p-4 sticky top-0 z-50 flex justify-between items-center shadow-md">
        <h1 class="text-lg font-bold">ğŸ§­ {{ currentTabName }}</h1>
        <button @click="exportData" class="text-xs bg-white/10 px-3 py-1 rounded">å‚™ä»½</button>
    </header>

    <main class="tab-content p-4">
        
        <section v-show="activeTab === 'input'" class="space-y-4 safe-bottom">
            <div class="bg-white p-6 rounded-2xl shadow-sm border">
                <h2 class="font-bold mb-4 text-slate-800">{{ isEditing ? 'âœï¸ ç·¨è¼¯å®¢æˆ¶äººè„ˆ' : 'â• æ–°å¢å®¢æˆ¶' }}</h2>
                
                <div class="space-y-4">
                    <div class="grid grid-cols-3 gap-2">
                        <div class="col-span-1">
                            <label class="text-xs font-bold text-slate-400">ç­‰ç´š</label>
                            <select v-model="form.level" class="w-full p-3 bg-slate-50 border rounded-xl">
                                <option value="A">A</option><option value="B">B</option><option value="C">C</option>
                            </select>
                        </div>
                        <div class="col-span-2">
                            <label class="text-xs font-bold text-slate-400">å§“å</label>
                            <input v-model="form.name" type="text" class="w-full p-3 bg-slate-50 border rounded-xl">
                        </div>
                    </div>

                    <div class="space-y-4">
                        <div>
                            <label class="text-xs font-bold text-slate-400">ğŸ‚ ç”Ÿæ—¥</label>
                            <input v-model="form.birthday" type="date" class="w-full p-3 bg-slate-50 border rounded-xl">
                        </div>
                        <div>
                            <label class="text-xs font-bold text-slate-400">ğŸ’° å¹´æ”¶å…¥(è¬)</label>
                            <input v-model.number="form.income" type="number" class="w-full p-3 bg-slate-50 border rounded-xl">
                        </div>
                    </div>

                    <hr>

                    <div>
                        <label class="text-xs font-bold text-blue-600">ğŸ’¼ è·æ¥­å·¥ä½œ (äººè„ˆåœˆé è¨­)</label>
                        <input v-model="form.job" list="job-list" @blur="addTag('jobs', form.job)" class="w-full p-3 bg-slate-50 border rounded-xl" placeholder="è¼¸å…¥æˆ–é¸æ“‡è·æ¥­">
                        <datalist id="job-list">
                            <option v-for="tag in tagPool.jobs" :key="tag" :value="tag">{{ tag }}</option>
                        </datalist>
                    </div>

                    <div>
                        <label class="text-xs font-bold text-slate-400">ğŸ¤ å¼•è–¦äºº</label>
                        <select v-model="form.linkName" class="w-full p-3 bg-slate-50 border rounded-xl">
                            <option value="">(ç„¡)</option>
                            <option v-for="c in customers" :value="c.name" :disabled="c.name === form.name">{{ c.name }}</option>
                        </select>
                        <label class="text-xs font-bold text-slate-400 mt-2 block">èˆ‡å¼•è–¦äººé—œä¿‚</label>
                        <input v-model="form.relationLabel" list="rel-list" @blur="addTag('relations', form.relationLabel)" class="w-full p-3 bg-slate-50 border rounded-xl" placeholder="è¼¸å…¥é—œä¿‚æ¨™ç±¤ (å¦‚ï¼šå®¶äººã€åŒäº‹)">
                        <datalist id="rel-list">
                            <option v-for="tag in tagPool.relations" :key="tag" :value="tag">{{ tag }}</option>
                        </datalist>
                    </div>

                    <div v-if="isEditing" class="p-4 bg-blue-50 rounded-xl border border-blue-100">
                        <label class="text-xs font-bold text-blue-800">ğŸŒ å»ºç«‹è‡ªå®šç¾©äººè„ˆåœˆ (å¦‚ï¼šèˆˆè¶£)</label>
                        <input v-model="newCircleTag" list="circle-list" class="w-full p-3 bg-white border rounded-xl mt-1" placeholder="æ¨™ç±¤åç¨± (ä¾‹ï¼šç™»å±±)">
                        <datalist id="circle-list">
                            <option v-for="tag in tagPool.circles" :key="tag" :value="tag">{{ tag }}</option>
                        </datalist>
                        
                        <label class="text-xs font-bold text-blue-800 mt-2 block">é€£çµåå–®ä¸­çš„å…¶ä»–äºº</label>
                        <div class="max-h-32 overflow-y-auto bg-white p-2 rounded-lg border text-sm">
                            <div v-for="c in customers" :key="c.id" v-show="c.name !== form.name">
                                <label class="flex items-center gap-2 p-1">
                                    <input type="checkbox" :value="c.name" v-model="tempCircleMembers"> {{ c.name }}
                                </label>
                            </div>
                        </div>
                        <button @click="linkToCircle" class="w-full mt-2 bg-blue-500 text-white py-2 rounded-lg text-xs">ç¢ºèªé€£çµäººè„ˆåœˆ</button>
                    </div>
                </div>

                <div class="mt-8 pb-10">
                    <button @click="saveData" class="w-full bg-slate-900 text-white font-bold py-4 rounded-2xl shadow-xl">
                        {{ isEditing ? 'ç¢ºèªæ›´æ–°åå–®' : 'ç¢ºèªå„²å­˜åå–®' }}
                    </button>
                    <button v-if="isEditing" @click="resetForm" class="w-full mt-3 text-slate-400 text-sm">å–æ¶ˆç·¨è¼¯</button>
                </div>
            </div>
        </section>

        <section v-show="activeTab === 'list'" class="space-y-3 safe-bottom">
            <input v-model="searchQuery" type="text" placeholder="ğŸ” æœå°‹å§“åã€è·æ¥­ã€é—œä¿‚..." class="w-full p-4 rounded-2xl border sticky top-0 bg-white/90 backdrop-blur z-10">
            
            <div v-for="c in filteredCustomers" :key="c.id" class="bg-white rounded-2xl border p-4">
                <div class="flex justify-between items-start" @click="toggleExpand(c)">
                    <div>
                        <div class="flex items-center gap-2">
                            <span class="font-black text-blue-600">{{ c.level }}</span>
                            <span class="font-bold text-lg">{{ c.name }}</span>
                        </div>
                        <div class="flex flex-wrap gap-1 mt-1">
                            <span v-if="c.job" class="tag-chip">è·:{{ c.job }}</span>
                            <span v-if="c.relationLabel" class="tag-chip">ä¿‚:{{ c.relationLabel }}</span>
                            <span v-for="circle in c.customCircles" class="tag-chip bg-blue-100 text-blue-600">#{{ circle.tag }}</span>
                        </div>
                    </div>
                    <span class="text-slate-300">{{ expandedId === c.id ? 'â–²' : 'â–¼' }}</span>
                </div>
                
                <div v-if="expandedId === c.id" class="mt-4 pt-4 border-t space-y-4">
                    <div class="flex gap-2">
                        <button @click.stop="startEdit(c)" class="flex-1 py-2 bg-blue-50 text-blue-600 rounded-lg text-xs font-bold">ç·¨è¼¯/åŠ æ¨™ç±¤</button>
                        <button @click.stop="deleteData(c.id)" class="flex-1 py-2 bg-red-50 text-red-600 rounded-lg text-xs font-bold">åˆªé™¤</button>
                    </div>
                    
                    <div>
                        <p class="text-xs font-bold text-slate-400 mb-1">ğŸ” é è¨­äººè„ˆåœˆ (å®¶äººèˆ‡è·æ¥­)</p>
                        <div :id="'sub-net-default-' + c.id" class="sub-network"></div>
                    </div>

                    <div v-for="(circle, idx) in c.customCircles" :key="idx">
                        <p class="text-xs font-bold text-blue-400 mb-1">ğŸ” èˆˆè¶£äººè„ˆåœˆï¼š{{ circle.tag }}</p>
                        <div :id="'sub-net-circle-' + c.id + '-' + idx" class="sub-network"></div>
                    </div>
                </div>
            </div>
        </section>

        <section v-show="activeTab === 'map'">
            <div id="main-network"></div>
        </section>

    </main>

    <nav class="fixed bottom-0 w-full bg-white/90 backdrop-blur border-t flex justify-around p-2 pb-6 z-50">
        <button @click="activeTab = 'input'" class="flex flex-col items-center flex-1" :class="{'active-tab': activeTab === 'input'}">
            <span class="text-xl">âœï¸</span><span class="text-[10px] mt-1 font-bold">è³‡æ–™/æ¨™ç±¤</span>
        </button>
        <button @click="activeTab = 'list'" class="flex flex-col items-center flex-1" :class="{'active-tab': activeTab === 'list'}">
            <span class="text-xl">ğŸ“‹</span><span class="text-[10px] mt-1 font-bold">åå–®åœˆå­</span>
        </button>
        <button @click="activeTab = 'map'" class="flex flex-col items-center flex-1" :class="{'active-tab': activeTab === 'map'}">
            <span class="text-xl">ğŸ•¸ï¸</span><span class="text-[10px] mt-1 font-bold">å…¨åŸŸåœ–</span>
        </button>
    </nav>
</div>

<script>
const { createApp, ref, computed, watch, nextTick, onMounted } = Vue;

createApp({
    setup() {
        const activeTab = ref('list');
        const customers = ref([]);
        const tagPool = ref({ jobs: [], relations: [], circles: [] });
        const searchQuery = ref('');
        const expandedId = ref(null);
        const isEditing = ref(false);
        const editingId = ref(null);
        
        // é¡å¤–ç·¨è¼¯ç”¨
        const newCircleTag = ref('');
        const tempCircleMembers = ref([]);

        const form = ref({
            name: '', level: 'B', birthday: '', income: 0, 
            job: '', linkName: '', relationLabel: '', customCircles: []
        });

        const currentTabName = computed(() => {
            const map = { input: 'å®¢æˆ¶è³‡æ–™èˆ‡æ¨™ç±¤ç®¡ç†', list: 'åå–®èˆ‡äººè„ˆåœˆè©³æƒ…', map: 'å…¨åŸŸäººè„ˆåœ°åœ–' };
            return map[activeTab.value];
        });

        const loadData = () => {
            const d = localStorage.getItem('crm_v5_data');
            const t = localStorage.getItem('crm_v5_tags');
            if (d) customers.value = JSON.parse(d);
            if (t) tagPool.value = JSON.parse(t);
        };

        const addTag = (type, val) => {
            if (val && !tagPool.value[type].includes(val)) {
                tagPool.value[type].push(val);
                localStorage.setItem('crm_v5_tags', JSON.stringify(tagPool.value));
            }
        };

        const saveData = () => {
            if(!form.value.name) return alert('å§“åå¿…å¡«');
            if(isEditing.value) {
                const idx = customers.value.findIndex(c => c.id === editingId.value);
                customers.value[idx] = { ...form.value, id: editingId.value };
            } else {
                customers.value.push({ ...form.value, id: Date.now(), customCircles: [] });
            }
            localStorage.setItem('crm_v5_data', JSON.stringify(customers.value));
            alert('å„²å­˜å®Œæˆ');
            resetForm();
            activeTab.value = 'list';
        };

        const linkToCircle = () => {
            if(!newCircleTag.value) return alert('è«‹è¼¸å…¥æ¨™ç±¤åç¨±');
            addTag('circles', newCircleTag.value);
            
            // å°‡è‡ªå·±åŠ å…¥æ¨™ç±¤
            if(!form.value.customCircles) form.value.customCircles = [];
            form.value.customCircles.push({ tag: newCircleTag.value, members: [...tempCircleMembers.value] });
            
            // åŒæ­¥æ¨™è¨»å…¶ä»–äºº (é›™å‘å‘ˆç¾)
            tempCircleMembers.value.forEach(mName => {
                const target = customers.value.find(c => c.name === mName);
                if(target) {
                    if(!target.customCircles) target.customCircles = [];
                    // æª¢æŸ¥æ˜¯å¦å·²æœ‰æ­¤æ¨™ç±¤ï¼Œé¿å…é‡è¤‡
                    if(!target.customCircles.find(x => x.tag === newCircleTag.value)) {
                        target.customCircles.push({ tag: newCircleTag.value, members: [form.value.name] });
                    } else {
                        target.customCircles.find(x => x.tag === newCircleTag.value).members.push(form.value.name);
                    }
                }
            });
            alert('æ¨™ç±¤é€£çµå®Œæˆ');
            newCircleTag.value = '';
            tempCircleMembers.value = [];
        };

        const resetForm = () => {
            form.value = { name: '', level: 'B', birthday: '', income: 0, job: '', linkName: '', relationLabel: '', customCircles: [] };
            isEditing.value = false;
            editingId.value = null;
        };

        const startEdit = (c) => {
            form.value = { ...c };
            isEditing.value = true;
            editingId.value = c.id;
            activeTab.value = 'input';
        };

        const toggleExpand = (c) => {
            expandedId.value = expandedId.value === c.id ? null : c.id;
            if(expandedId.value) {
                nextTick(() => {
                    renderSubMap(c, 'default', [c.relationLabel, c.job]);
                    if(c.customCircles) {
                        c.customCircles.forEach((circle, idx) => {
                            renderSubMap(c, 'circle-' + idx, [circle.tag], circle.members);
                        });
                    }
                });
            }
        };

        const renderSubMap = (root, suffix, tags, directMembers = []) => {
            const container = document.getElementById('sub-net-' + suffix + '-' + root.id);
            if(!container) return;

            // éæ¿¾ç›¸é—œäººï¼šæˆ–è€…æ˜¯å¼•è–¦é—œä¿‚ï¼Œæˆ–è€…æ˜¯è·æ¥­æ¨™ç±¤ï¼Œæˆ–è€…æ˜¯è‡ªå®šç¾©æ¨™ç±¤æˆå“¡
            const related = customers.value.filter(c => 
                c.name === root.name || 
                c.linkName === root.name || 
                root.linkName === c.name ||
                tags.includes(c.job) ||
                tags.includes(c.relationLabel) ||
                directMembers.includes(c.name)
            );

            const nodes = related.map(c => ({
                id: c.name, label: c.name, shape: 'dot', size: c.name === root.name ? 15 : 10,
                color: c.name === root.name ? '#ef4444' : '#3b82f6'
            }));
            const edges = related.filter(c => c.linkName).map(c => ({ from: c.linkName, to: c.name, color: '#444' }));
            
            // é‡å°è‡ªå®šç¾©æˆå“¡ç•«è™›ç·šé€£çµ
            directMembers.forEach(m => {
                edges.push({ from: root.name, to: m, dashes: true, color: '#3b82f6' });
            });

            new vis.Network(container, { nodes, edges }, { physics: { enabled: true }});
        };

        const filteredCustomers = computed(() => {
            const q = searchQuery.value.toLowerCase();
            return customers.value.filter(c => 
                c.name.includes(q) || (c.job && c.job.includes(q))
            ).sort((a,b) => a.level.localeCompare(b.level));
        });

        onMounted(loadData);
        watch(activeTab, (t) => { if(t === 'map') nextTick(() => renderMainMap()); });

        return { activeTab, currentTabName, customers, tagPool, searchQuery, expandedId, isEditing, form, newCircleTag, tempCircleMembers, saveData, addTag, startEdit, toggleExpand, resetForm, linkToCircle, filteredCustomers };
    }
}).mount('#app');
</script>
</body>
</html>

